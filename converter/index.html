<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">

  <title>GoT Data Converter</title>

  <style type="text/css">
    
    html, body, main {
      height: 100%; 
    }

    main {
      padding: 1em 2em;
      max-width: 940px;
      max-height: 680px;
    }

    button {
      font-size: 1em;
      padding: .5em;
      cursor: pointer;
    }

    button:hover {
      color: #666;
    }

    textarea {
      font-family: monospace;
      margin-top: 2em;
      height: 50%;
      width: 100%;
    }
  </style>

  <script type="text/javascript" src="miso.ds.min.js"></script>
  <script type="text/javascript" src="filesaver.min.js"></script>
  </head>

  <body>

    <main>

      <h2>GoT Data Converter</h2>
      <p>Get the caracter data from a Google Spreadsheets and convert it, so it can be used with the application.</p>
      <form>
        <button type="button" id="get-data">Get and convert data</button>
        <button type="button" id="save-file">Download file</button>
      </form>
      <textarea id="result"></textarea>

    </main>

    <script>

      var key = "1SbMWBGGvdh3iKwWIMRL7lHZzKjWfB8oCqMNwKcq8tIY";
      var data = {};
      var loaded = 0;
      var blob;
      
      document.getElementById("get-data").onclick = getData;
      document.getElementById("save-file").onclick = saveFile;

      function getData() {

        getSpreadsheet(key, 1, handler);
        getSpreadsheet(key, 2, handler);
      }

      function getSpreadsheet(key, worksheet, handler) {

        var ds = new Miso.Dataset({

          importer : Miso.Dataset.Importers.GoogleSpreadsheet,
          parser : Miso.Dataset.Parsers.GoogleSpreadsheet,
          key : key,
          worksheet : worksheet
        });

        ds.fetch({ 

          success : function() {

            handler(ds, worksheet);
          },
          error : function() {

            outputData("Couldn't get data. Are you sure you are connected to the internet and your spreadsheet is public?");
          }
        });
      }

      function handler(ds, worksheet) {
        
        loaded += worksheet;

        if (worksheet === 1) {

          data.relations = _.filter(ds.toJSON(), function (obj) { return obj.source; });
        }

        if (worksheet === 2) {
          data.characters = _.filter(ds.toJSON(), function (obj) { return obj.name; });
        }

        if (loaded === 3) {
          outputData(JSON.stringify(data));
        }

      }
     
      function convertData(json) {

        _.each(json, function(obj) {

          if (arrayHasProperty(characters, "name", obj.name)) {

          } else {
            var character = {
              name: obj.name,
              relations: []
            };

            _.each(_.where(json, {name: obj.name}), function(obj) {

              character.relations.push({

                person: obj.person,
                type: obj.type,
                start: obj.start,
                end: obj.end,
              });
            });

            characters.push(character);
          }
        });

        outputData(JSON.stringify(characters));
      }

      function outputData(string) {

        document.getElementById("result").value = string;
        blob = new Blob([string], {type: "application/json;charset=utf-8"});
      }

      function saveFile() {

        if (blob) {
          saveAs(blob, "data.json");
        } else {
          getData();
        }
      }
        
      function arrayHasProperty(arr, key, value) {

        var result = arr.filter(function (obj) {

          return obj[key] == value;
        });

        return result.length;
      }
    </script>

  </body>

</html>
